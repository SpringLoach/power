## 项目规范

1.文件夹、文件名称统一小写、多个单词以连接符（-）连接； 

2.JavaScript变量名称采用小驼峰标识，常量全部使用大写字母，组件采用大驼峰；

3.CSS采用普通CSS和styled-component结合来编写（全局采用普通CSS、局部采用styled-component）; 

4.整个项目不再使用class组件，统一使用函数式组件，并且全面拥抱Hooks； 

5.所有的函数式组件，为了避免不必要的渲染，全部使用memo进行包裹； 

6.组件内部的状态，使用useState、useReducer；业务数据全部放在redux中管理； 

7.函数组件内部基本按照如下顺序编写代码： 

- 组件内部state管理；
- redux的hooks代码；
- 其他组件hooks代码； 
- 其他逻辑代码； 
- 返回JSX代码；

8.redux代码规范如下： 

- 每个模块有自己独立的reducer，通过combineReducer进行合并； 

- 异步请求代码使用redux-thunk，并且写在actionCreators中； 

- redux直接采用redux hooks方式编写，不再使用connect； 

9.网络请求采用axios 

- 对axios进行二次封装； 

- 所有的模块请求会放到一个请求文件中单独管理； 

10.项目使用AntDesign 

- 项目中某些AntDesign中的组件会被拿过来使用； 

- 但是多部分组件还是自己进行编写；



## 创建项目

```elm
create-react-app hy-music-react
```



### 项目配置-1

1. 删除多余文件

<img src=".\img\创建项目1" alt="image-20220724015108430" style="zoom: 80%;" />



2. 清除 <span style="backGround: #efe0b9">public/index.html</span> 中多余代码

3. 新建 <span style="backGround: #efe0b9">src/App.js</span>

   ```react
   import React, { memo } from 'react';
   
   export default memo(function App() {
     return (
       <div>React App</div>
     )
   })
   ```

   :hammer_and_wrench: 在 vscode 安装对应插件后，输入 `rmc` 即可快速生成对应模板

4. 清理 <span style="backGround: #efe0b9">src/index.js</span> 中多余代码

   ```react
   import React from 'react';
   import ReactDOM from 'react-dom';
   
   import App from './App';
   
   ReactDOM.render(
     <App />,
     document.getElementById('root')
   )
   ```

   :hammer_and_wrench: 不开启严格模式了



### 项目配置-2

1. 搭建结构

```elm
- src
  + assets
    -img
    - css
    - font       # 字体图标、字体
  - pages
  - components   # 公共组件
  - router		 # 路由配置
  - store	     # redux
  - services     # 网络请求
  - utils	
  - common		 # 公共常量
```



2. css重置

   <span style="backGround: #efe0b9">src\assets\css\reset.css</span>

   ```css
   @import "~normalize.css";
   
   /* 公共样式 */
   ```

   :turtle: 如果是通过依赖安装的方式得到的样式文件，需要加上 `~` 引入该模块；

   :hammer_and_wrench: 公共样式里，添加了统一规范、工具类、图片背景等。

   <span style="backGround: #efe0b9">src\index.js</span>

   ```css
   import "@/assets/css/reset.css";
   ```

   

3. 添加别名

   ```elm
   yarn add @craco/craco
   ```

   :european_castle: 在不暴露 webpack 的前提下，进行一些额外配置

   <span style="backGround: #efe0b9">package.json</span>

   ```json
   "scripts": {
     "start": "craco start",
     "build": "craco build",
     "test": "craco test",
     "eject": "react-scripts eject"
   },
   ```

   <span style="backGround: #efe0b9">craco.config.js</span>

   ```react
   const path = require("path");
   
   const resolve = dir => path.resolve(__dirname, dir);
   
   module.exports = {
     webpack: {
       alias: {
         "@": resolve("src"),
         "components": resolve("src/components")
       }
     }
   }
   ```

   

### 项目配置-3

页面整体分为固定的头部、动态切换的中间部分、固定的尾部三部分。

1. 设置大体框架

```elm
- src
  + components
    - app-header
      + index.js
    - app-footer
      + index.js
```

<span style="backGround: #efe0b9">src\components\app-header\index.js</span>

```react
import React, { memo } from 'react'

export default memo(function HYAppHeader() {
  return (
    <div>HYAppHeader</div>
  )
})
```

<span style="backGround: #efe0b9">src\components\app-footer\index.js</span>

```react
import React, { memo } from 'react'

export default memo(function HYAppFooter() {
  return (
    <div>HYAppFooter</div>
  )
})
```

<span style="backGround: #efe0b9">src\App.js</span>

```react
import React, { memo } from 'react';

import HYAppHeader from '@/components/app-header';
import HYAppFooter from '@/components/app-footer';

export default memo(function App() {
  return (
    <div>
      <HYAppHeader />
      <h2>Content</h2>
      <HYAppFooter />
    </div>
  )
})
```



2. 配置中间的路由区域

   路由相关

   ```elm
   yarn add react-router-dom
   ```

   路由映射统一管理

   ```elm
   yarn add react-router-config
   ```

   ```elm
   + router
     - index.js
   + pages
     - discover
       + index.js
     - friend
       + index.js
     - mine
       + index.js
   ```

   <span style="backGround: #efe0b9">src\router\index.js</span>

   ```react
   import React from 'react';
   import { Redirect } from "react-router-dom";
   
   import HYDiscover from "@/pages/discover";
   import HYMine from "@/pages/mine";
   import HYFriend from "@/pages/friend";
   
   const routes = [
     {
       path: "/",
       exact: true,
       render: () => (
         <Redirect to="/discover"/>
       )
     },
     {
       path: "/discover",
       component: HYDiscover
     },
     {
       path: "/mine",
       component: HYMine
     },
     {
       path: "/friend",
       component: HYFriend
     },
   ];
   
   export default routes;
   ```

   :european_castle: 对于根级别的路由，需要加上 exact 配置表示精准匹配；

   :ghost: 这里使用路由的<span style="color: #a50">重定向</span>，可以解决模糊匹配带来的激活问题。

   <span style="backGround: #efe0b9">src\App.js</span>

   ```react
   import React, { memo } from 'react';
   import { renderRoutes } from 'react-router-config';
   
   import routes from './router';
   
   import { HashRouter } from 'react-router-dom';
   import HYAppHeader from '@/components/app-header';
   import HYAppFooter from '@/components/app-footer';
   
   export default memo(function App() {
     return (
       <HashRouter>
         <HYAppHeader />
         {renderRoutes(routes)}
         <HYAppFooter />
       </HashRouter>
     )
   })
   ```



### 头部搭建

```elm
- src
  + commom
    - local-data.js
  + comonents
    - app-header
      + index.js
      + style.js
```

#### 使用局部样式

```elm
yarn add styled-components
```



#### 引入 ant-design

```elm
yarn add antd
```

引入 ant-design 图标

```elm
yarn add @ant-design/icons
```

引入 ant-design 样式

<span style="backGround: #efe0b9">src\assets\css\reset.css</span>

```elm
@import "~antd/dist/antd.css";
```



#### 配置链接列表

<span style="backGround: #efe0b9">src\common\local-data.js</span>

```javascript
export const headerLinks = [
  {
    title: "发现音乐",
    link: "/discover"
  },
  {
    title: "我的音乐",
    link: "/mine"
  },
  {
    title: "朋友",
    link: "/friend"
  },
  {
    title: "商城",
    link: "https://music.163.com/store/product"
  },
  {
    title: "音乐人",
    link: "https://music.163.com/nmusician/web/index#/"
  },
  {
    title: "下载客户端",
    link: "https://music.163.com/#/download"
  }
]
```

#### 编写组件

<span style="backGround: #efe0b9">src\components\app-header\index.js</span>

```react
import React, { memo } from 'react';

import { headerLinks } from "@/common/local-data";

import { NavLink } from 'react-router-dom';
import { SearchOutlined } from '@ant-design/icons'
import { Input } from "antd";
import {
  HeaderWrapper,
  HeaderLeft,
  HeaderRight
} from './style';

export default memo(function HYAppHeader() {

  // 页面代码
  const showSelectItem = (item, index) => {
    if (index < 3) {
      return (
        <NavLink to={item.link}>
          {item.title}
          <i className="sprite_01 icon"></i>
        </NavLink>
      )
    } else {
      return <a href={item.link}>{item.title}</a>
    }
  }

  // 返回的jsx
  return (
    <HeaderWrapper>
      <div className="content wrap-v1">
        <HeaderLeft>
          <a href="#/" className="logo sprite_01">网易云音乐</a>
          <div className="select-list">
            {
              headerLinks.map((item, index) => {
                return (
                  <div key={item.title} className="select-item">
                    {showSelectItem(item, index)}
                  </div>
                )
              })
            }
          </div>
        </HeaderLeft>
        <HeaderRight>
          <Input className="search" placeholder="音乐/视频/电台/用户" prefix={<SearchOutlined />}/>
          <div className="center">创作者中心</div>
          <div>登录</div>
        </HeaderRight>
      </div>
      <div className="divider"></div>
    </HeaderWrapper>
  )
})
```

:ghost: 对于路由跳转 / 跳转外部链接，分别使用 <span style="color: #a50">NavLink / a 标签</span>处理；

:turtle: 给 Ant design 的 Input 组件添加图标前缀，需要额外引入图标组件；



#### 组件样式

<span style="backGround: #efe0b9">src\components\app-header\style.js</span>

```less
import styled from "styled-components";

export const HeaderWrapper = styled.div`
  height: 75px;
  font-size: 14px;
  color: #fff;
  background-color: #242424;

  .content {
    height: 70px;

    display: flex;
    justify-content: space-between;
  }

  .divider {
    height: 5px;
    background-color: #C20C0C;
  }
`

export const HeaderLeft = styled.div`
  display: flex;

  .logo {
    display: block;
    width: 176px;
    height: 69px;
    background-position: 0 0;
    text-indent: -9999px;
  }

  .select-list {
    display: flex;
    line-height: 70px;
    
    .select-item {
      position: relative;
      a {
        display: block;
        padding: 0 20px;
        color: #ccc;
      }

      :last-of-type a {
        position: relative;
        ::after {
          position: absolute;
          content: "";
          width: 28px;
          height: 19px;
          background-image: url(${require("@/assets/img/sprite_01.png")});
          background-position: -190px 0;
          top: 20px;
          right: -15px;
        }
      }

      &:hover a, a.active {
        color: #fff;
        background: #000;
        text-decoration: none;
      }
      
      .active .icon {
        position: absolute;
        display: inline-block;
        width: 12px;
        height: 7px;
        bottom: -1px;
        left: 50%;
        transform: translate(-50%, 0);
        background-position: -226px 0;
      }
    }
  }
`

export const HeaderRight = styled.div`
  display: flex;
  align-items: center;
  color: #ccc;
  font-size: 12px;


  .search {
    width: 158px;
    height: 32px;
    border-radius: 16px;

    input {
      &::placeholder {
        font-size: 12px;
      }
    }
  }

  .center {
    width: 90px;
    height: 32px;
    line-height: 32px;
    text-align: center;
    border: 1px solid #666;
    border-radius: 16px;
    margin: 0 16px;
    background-color: transparent;
  }
`
```

:ghost: 样式中引入图片资源时，需要以模块方式引入；

:turtle: 通过设置 `text-indent` 属性，可以在界面不显示 a 标签的内容，但又保留优化 seo 的特点；

:whale: 对于激活的组件链接，默认情况下就添加上了特殊类 `.active`；



### 尾部搭建

```elm
- src
  + commom
    - local-data.js
  + comonents
    - app-footer
      + index.js
      + style.js
```

#### 配置链接列表

<span style="backGround: #efe0b9">src\common\local-data.js</span>

```javascript
export const footerLinks = [
  {
    title: "服务条款",
    link: "https://st.music.163.com/official-terms/service"
  },
  {
    title: "隐私政策",
    link: "https://st.music.163.com/official-terms/privacy"
  },
  {
    title: "儿童隐私政策",
    link: "https://st.music.163.com/official-terms/children"
  },
  {
    title: "版权投诉指引",
    link: "https://music.163.com/st/staticdeal/complaints.html"
  },
  {
    title: "意见反馈",
    link: "#"
  }
]

export const footerImages = [
  {
    link: "https://music.163.com/st/userbasic#/auth"
  },
  {
    link: "https://music.163.com/recruit"
  },
  {
    link: "https://music.163.com/web/reward"
  },
  {
    link: "https://music.163.com/uservideo#/plan"
  }
]
```



#### 编写组件

<span style="backGround: #efe0b9">src\components\app-footer\index.js</span>

```react
import React, { memo, Fragment } from 'react';

import { footerLinks, footerImages } from "@/common/local-data";

import {
  AppFooterWrapper,
  FooterLeft,
  FooterRight,
} from './style';

export default memo(function HYAppFooter() {
  return (
  <AppFooterWrapper>
    <div className="wrap-v2 content">
      <FooterLeft className="left">
        <div className="link">
          {
            footerLinks.map(item => {
              return (
                <Fragment key={item.title}>
                  <a href={item.link} target="_blank" rel="noopener noreferrer">{item.title}</a>
                  <span className="line">|</span>
                </Fragment>
              )
            })
          }
        </div>
        <div className="copyright">
          <span>网易公司版权所有©1997-2020</span>
          <span>
            杭州乐读科技有限公司运营：
            <a href="https://p1.music.126.net/Mos9LTpl6kYt6YTutA6gjg==/109951164248627501.png" rel="noopener noreferrer" target="_blank">浙网文[2018]3506-263号</a>
          </span>
        </div>
        <div className="report">
          <span>违法和不良信息举报电话：0571-89853516</span>
          <span>
            举报邮箱：
            <a href="mailto:ncm5990@163.com" target="_blank" rel="noopener noreferrer">ncm5990@163.com</a>
          </span>
        </div>
        <div className="info">
          <span>粤B2-20090191-18</span>
          <a href="http://www.beian.miit.gov.cn/publish/query/indexFirst.action" rel="noopener noreferrer" target="_blank">
            工业和信息化部备案管理系统网站
          </a>
        </div>
      </FooterLeft>
      <FooterRight className="right">
        {
          footerImages.map((item, index) => {
            return (
              <li className="item" key={item.link}>
                <a className="link" href={item.link} rel="noopener noreferrer" target="_blank"> </a>
                <span className="title">{item.title}</span>
              </li>
            )
          })
        }
      </FooterRight>
    </div>
  </AppFooterWrapper>
  )
})
```

:european_castle: 这里遍历时使用的 <span style="color: #a50">Fragment</span>，相当于 Vue 中的 template。

#### 组件样式

<span style="backGround: #efe0b9">src\components\app-footer\style.js</span>

```less
import styled from 'styled-components';

export const AppFooterWrapper = styled.div`
  height: 172px;
  background-color: #f2f2f2;
  color: #666;
  border-top: 1px solid #d3d3d3;

  .content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
`

export const FooterLeft = styled.div`
  padding-top: 15px;
  line-height: 24px;

  .link {
    a {
      color: #999;
    }

    .line {
      margin: 0 10px;
      color: #999;
    }
  }

  .copyright {
    span {
      margin-right: 15px;
    }
  }
`

export const FooterRight = styled.ul`
  display: flex;

  .item {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-right: 40px;

    .link {
      display: block;
      width: 50px;
      height: 45px;

      background-image: url(${require("@/assets/img/sprite_footer_02.png")});
      background-size: 110px 450px;
    }

    :nth-child(1) .link {
      background-position: -60px -101px;
    }
    :nth-child(2) .link {
      background-position: 0 0;
    }
    :nth-child(3) .link {
      background-position: -60px -50px;
    }
    :nth-child(4) .link {
      background-position: 0 -101px;
    }

    .title {
      margin-top: 5px;
      display: block;
      width: 52px;
      height: 10px;
      background-image: url(${require("@/assets/img/sprite_footer_01.png")});
      background-size: 180px 100px;
    }

    :nth-child(1) .title {
      background-position: -1px -90px;
    }
    :nth-child(2) .title {
      background-position: 0 0;
      margin-top: 7px;
    }
    :nth-child(3) .title {
      background-position: 0 -54px;
      margin-top: 6px;
    }

    :nth-child(4) .title {
      background-position: -1px -72px;
      margin-top: 6px;
    }
  }
`
```



### 发现音乐

> 设计二级菜单的创建，及路由嵌套的实现。

```elm
- src
  + common
    - local-data.js
  + pages
    - discover
      + c-pages  // 嵌套路由对应的页面
        - album
          + index.js
        - artist
          + index.js
        - djradio
          + index.js
        - ranking
          + index.js
        - recommend
          + index.js
        - songs
          + index.js
      + index.js
```

#### 配置链接列表

<span style="backGround: #efe0b9">src\common\local-data.js</span>

```javascript
export const dicoverMenu = [
  {
    title: "推荐",
    link: "/discover/recommend"
  },
  {
    title: "排行榜",
    link: "/discover/ranking"
  },
  {
    title: "歌单",
    link: "/discover/songs"
  },
  {
    title: "主播电台",
    link: "/discover/djradio"
  },
  {
    title: "歌手",
    link: "/discover/artist"
  },
  {
    title: "新碟上架",
    link: "/discover/album"
  },
]
```

#### 配置嵌套路由

```javascript
import React from 'react';
import { Redirect } from "react-router-dom";

import HYDiscover from "@/pages/discover";
import HYRecommend from "../pages/discover/c-pages/recommend";
import HYRanking from "../pages/discover/c-pages/ranking";
import HYSongs from "../pages/discover/c-pages/songs";
import HYDjradio from "../pages/discover/c-pages/djradio";
import HYArtist from "../pages/discover/c-pages/artist";
import HYAlbum from "../pages/discover/c-pages/album";

import HYMine from "@/pages/mine";
import HYFriend from "@/pages/friend";


const routes = [
  {
    path: "/",
    exact: true,
    render: () => (
      <Redirect to="/discover"/>
    )
  },
  {
    path: "/discover",
    component: HYDiscover,
    routes: [
      {
        path: "/discover",
        exact: true,
        render: () => (
          <Redirect to="/discover/recommend"/>
        )
      },
      {
        path: "/discover/recommend",
        component: HYRecommend
      },
      {
        path: "/discover/ranking",
        component: HYRanking
      },
      {
        path: "/discover/songs",
        component: HYSongs
      },
      {
        path: "/discover/djradio",
        exact: true,
        component: HYDjradio
      },
      {
        path: "/discover/artist",
        component: HYArtist
      },
      {
        path: "/discover/album",
        component: HYAlbum
      }
    ]
  },
  {
    path: "/mine",
    component: HYMine
  },
  {
    path: "/friend",
    component: HYFriend
  },
];

export default routes;
```



#### 编写组件

<span style="backGround: #efe0b9">src\pages\discover\index.js</span>

```react
import React, { memo } from 'react';
import { renderRoutes } from 'react-router-config';

import { dicoverMenu } from "@/common/local-data";

import { NavLink } from 'react-router-dom';
import {
  DiscoverWrapper,
  TopMenu
} from './style';

export default memo(function HYDiscover(props) {
  const { route } = props;

  return (
    <DiscoverWrapper>
      <div className="top">
        <TopMenu className="wrap-v1">
          {
            dicoverMenu.map((item, index) => {
              return (
                <div className="item" key={item.title}>
                  <NavLink to={item.link}>{item.title}</NavLink>
                </div>
              )
            })
          }
        </TopMenu>
      </div>
      {renderRoutes(route.routes)}
    </DiscoverWrapper>
  )
})
```

#### 编写样式

<span style="backGround: #efe0b9">src\pages\discover\style.js</span>

```less
import styled from 'styled-components';

export const DiscoverWrapper = styled.div`
  .top {
    height: 30px;
    background-color: #C20C0C;
  }
`

export const TopMenu = styled.div`
  display: flex;
  padding-left: 180px;
  position: relative;
  top: -4px;

  .item {
    a {
      display: inline-block;
      height: 20px;
      line-height: 20px;
      padding: 0 13px;
      margin: 7px 17px 0;
      color: #fff;

      &:hover, &.active {
        text-decoration: none;
        background-color: #9B0909;
        border-radius: 20px;
      }
    }
  }
`
```





### 状态和请求封装

#### 请求底层封装

```elm
- src
  + services
    - config.js
    - request.js
```

```elm
yarn add axios
```

<span style="backGround: #efe0b9">src\services\config.js</span>

```javascript
const devBaseURL = "http://123.207.32.32:9001";
const proBaseURL = "http://123.207.32.32:9001";
export const BASE_URL = process.env.NODE_ENV === 'development' ? devBaseURL: proBaseURL;

export const TIMEOUT = 5000;
```

<span style="backGround: #efe0b9">src\services\request.js</span>

```javascript
import axios from 'axios';

import { BASE_URL, TIMEOUT } from "./config";

const instance = axios.create({
  baseURL: BASE_URL,
  timeout: TIMEOUT
});

instance.interceptors.request.use(config => {
  // 1.发送网络请求时, 在界面的中间位置显示Loading的组件

  // 2.某一些请求要求用户必须携带token, 如果没有携带, 那么直接跳转到登录页面

  // 3.params/data序列化的操作

  return config;
}, err => {

});

instance.interceptors.response.use(res => {
  return res.data;
}, err => {
  if (err && err.response) {
    switch (err.response.status) {
      case 400:
        console.log("请求错误");
        break;
      case 401:
        console.log("未授权访问");
        break;
      default:
        console.log("其他错误信息");
    }
  }
  return err;
});

export default instance;
```



#### 初始化Rudux

状态管理、状态管理与react的结合、管理异步操作

```elm
yarn add redux react-redux redux-thunk
```

```elm
- src
  + store
    - reducer.js
    - index.js
  + App.js
```



<span style="backGround: #efe0b9">src\store\index.js</span>

```react
import { createStore, applyMiddleware, compose } from 'redux';
import thunk from 'redux-thunk';
import reducer from './reducer';

// 用于支持浏览器的调试工具
const composeEnhancers = window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__ || compose;

// 第二个参数用于增强
const store = createStore(reducer, composeEnhancers(
  applyMiddleware(thunk)
));

export default store;
```

<span style="backGround: #efe0b9">src\store\reducer.js</span>

```react
import { combineReducers } from 'redux';

// 对拆分的 reducer 进行合并
const cReducer = combineReducers({
});

export default cReducer;
```

<span style="backGround: #efe0b9">src\App.js</span>

```react
import React, { memo, Suspense } from 'react';
// 引入以支持共享
import { Provider } from 'react-redux';
import { renderRoutes } from 'react-router-config';

import routes from './router';
// 引入以支持共享
import store from './store';

import { HashRouter } from 'react-router-dom';
import HYAppHeader from '@/components/app-header';
import HYAppFooter from '@/components/app-footer';

export default memo(function App() {
  return (
    <Provider store={store}>
      <HashRouter>
        <HYAppHeader />
        {renderRoutes(routes)}
        <HYAppFooter />
      </HashRouter>
    </Provider>
  )
})
```

:european_castle: 通过使用 Provider 包裹，给包裹内容提供共享状态的能力。



#### 模块Redux的组织

```elm
- src
  + pages
    - discover                    // 发现音乐模块
      + c-pages                   // 子路由页面
        - recommend               // 推荐模块
          + store                 // 管理相关的 reducer
            - actionCreators.js   // 定义 action
            - constants.js		  // 定义常量
            - index.js            // 入口文件
            - reducer.js		  // 定义初始状态 和 reducer方法
  + store
    - reducer.js
```

:trident: 这个项目的规范，是将每个模块对应的 reducer 交由自己管理，但这不会影响共享。



<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\constants.js</span>

```javascript
export const CHANGE_TOP_BANNERS = "recommend/CHANGE_TOP_BANNERS";
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\reducer.js</span>

```javascript
import * as actionTypes from './constants';

const defaultState = Map({
  topBanners: []
});

function reducer(state = defaultState, action) {
  switch (action.type) {
    case actionTypes.CHANGE_TOP_BANNERS:
      return {...state, topBanners: []}
    default:
      return state;
  }
}

export default reducer;
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\index.js</span>

```javascript
import reducer from './reducer';

export {
  reducer
}
```

<span style="backGround: #efe0b9">src\store\reducer.js</span>

```react
import { combineReducers } from 'redux';

import { reducer as recommendReducer } from '../pages/discover/c-pages/recommend/store';

const cReducer = combineReducers({
  recommend: recommendReducer
});

export default cReducer;
```

:trident: 对于导入的 reducer 起别名，可以避免由于导入多个 reducer  导致的命名冲突。



#### 请求轮播图数据

##### 普通实现

该项目将请求相关的逻辑放在 redux 中处理。

```elm
- src
  + pages
    - discover                    
      + c-pages                  
        - recommend              
          + store                
            - actionCreators.js   // 定义 action
            - constants.js		  // 定义常量
            - index.js           
            - reducer.js		  // 定义初始状态 和 reducer方法
  + services
    - recommend.js                // 模块相关的 API
```

**执行流程**

```
通过高阶组件 connect 将定义好的状态、方法传递给 HYRecommend 组件

HYRecommend 组件挂载
→ 触发网络请求对应 useEffect
→ 执行 getBanners()
→ 执行 dispatch(getTopBannerAction()) 
→ 即发起请求获取结果后，调用 dispatch(changeTopBannerAction(res))
→ 调用 dispatch(changeTopBannerAction(res)) 时会触发 reducer 并传递数据
→ 在 reducer 对应的处理逻辑中合并该结果到状态
→ 页面中本身使用到了状态
```



<span style="backGround: #efe0b9">src\services\recommend.js</span>

```javascript
import request from './request';

export function getTopBanners() {
  return request({
    url: "/banner"
  })
}
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\actionCreators.js</span>

```javascript
import * as actionTypes from './constants';

import { 
  getTopBanners
} from '@/services/recommend';

const changeTopBannerAction = (res) => ({
  type: actionTypes.CHANGE_TOP_BANNERS,
  topBanners: res.banners
});

export const getTopBannerAction = () => {
  return dispatch => {
    getTopBanners().then(res => {
      dispatch(changeTopBannerAction(res));
    })
  }
};
```

:ghost: 由于像 getTopBannerAction 这样的方法本身可能依赖额外参数（如表格的页码），故在函数内部返回一个，能够供 dispatch 调用的函数；

:hammer_and_wrench: 一般涉及到网络请求的，还会在内部继续调用其它的 action。

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\reducer.js</span>

```javascript
import * as actionTypes from './constants';

const defaultState = {
  topBanners: []
};

function reducer(state = defaultState, action) {
  switch (action.type) {
    case actionTypes.CHANGE_TOP_BANNERS:
      return {...state, topBanners: action.topBanners};
    default:
      return state;
  }
}

export default reducer;
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\index.js</span>

```react
import React, { memo } from 'react';
import { connect } from 'react-redux';

import { getTopBannerAction } from './store/actionCreators';

function HYRecommend(props) {
  const { getBanners, topBanners } = props;

  useEffect(() => {
    getBanners();
  }, [getBanners])

  return (
    <div>
      <h2>HYRecommend: {topBanners.length}</h2>
    </div>
  )
}

// 返回的（状态）对象属性最终会传递给组件的props
const mapStateToProps = state => ({
  topBanners: state.recommend.topBanners
});

// 返回的（方法）对象属性最终会传递给组件props
const mapDispatchToProps = dispatch => ({
  getBanners: () => {
    dispatch(getTopBannerAction())
  }
})

export default connect(mapStateToProps, mapDispatchToProps)(memo(HYRecommend));
```

:ghost: 将默认的组织形式修改，方便使用高阶组件 connect 为组件传递属性和方法；

:turtle: connect 方法的首个（回调）参数会被传递为全局state；

:turtle: connect 方法的第二（回调）参数会被传递为 dispatch；



##### redux  的 hook 优化

通过高阶组件传递状态和方法太麻烦了，可以用 redux 内置的 hook 做优化

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\index.js</span>

```react
import React, { memo } from 'react';
import { useSelector, useDispatch, shallowEqual } from 'react-redux';

import { getTopBannerAction } from './store/actionCreators';

function HYRecommend(props) {
  // 获取 redux 中的状态、dispatch方法
  const { topBanners } = useSelector(state => {
    topBanners: state.recommend.topBanners
  }, shallowEqual);
  const dispatch = useDispatch();

  useEffect(() => {
    dispatch(getTopBannerAction());
  }, [dispatch])

  return (
    <div>
      <h2>HYRecommend: {topBanners.length}</h2>
    </div>
  )
}

export default memo(HYRecommend);
```

:ghost: <span style="color: #a50">useSelector</span> 首参接收函数，函数参数即全局状态，函数返回值会作为最终返回值；

:ghost: 在 useEffect 中使用 dispatch 时，需要将其添加到依赖，否则会被警告；

:octopus: <span style="color: #a50">useSelector</span> 允许接收第二个参数 shallowEqual，如不传会导致任何全局状态的修改，都会导致组件重新渲染



##### 演示-immutable

| --        | --                                                           |
| --------- | ------------------------------------------------------------ |
| 传统拷贝  | 实现纯函数，通常使用拷贝对象的方法，但对于较复杂的对象，这影响性能，占用内存 |
| immutable | 虽然会生成新的对象，但通过算法处理，会复用原本的（树）结构（内存空间） |
| immutable | 这也利于性能优化                                             |
| Map       | 用于对象，浅层影响                                           |
| List      | 用于数组，浅层影响                                           |
| fromJS    | 用于对象，深层影响                                           |

```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/immutable/3.8.2/immutable.min.js"></script>
<script>
  const im = Immutable;

  // Map的使用
  const info = {
    name: "kobe",
    age: 30
  }
  const infoIM = im.Map(info);
  const infoIM2 = infoIM.set("name", "why");
    
  console.log(infoIM.get("name"));   // kobe
  console.log(infoIM2.get("name"));  // why

  // List的使用
  const names = ["abc", "cba", "nba"];
  const namesIM = im.List(names);
  const namesIM2 = namesIM.set(0, "why");
    
  console.log(namesIM.get(0));   // abc
  console.log(namesIM2.get(0));  // why
    
  // fromJS的使用
  const info = {
    name: "kobe",
    age: 30,
    friend: {
      name: "james",
      age: 25
    }
  }
  const infoIM = im.fromJS(info);
    
  console.log(infoIM.get("friend"));
</script>
```



##### 结合到项目

```elm
- src
  + pages
    - discover                   
      + c-pages                  
        - recommend              
          + store                 
            - reducer.js   // 改动
          + index.js       // 改动
  + store
    - reducer.js           // 改动
```

```elm
yarn add immutable redux-immutable
```

<span style="backGround: #efe0b9">src\store\reducer.js</span>

```react
import { combineReducers } from 'redux-immutable';

import { reducer as recommendReducer } from '../pages/discover/c-pages/recommend/store';
import { reducer as playerReducer } from '../pages/player/store';

const cReducer = combineReducers({
  recommend: recommendReducer,
  player: playerReducer
});

export default cReducer;
```

:ghost: 从 <span style="color: #a50">redux-immutable</span> 中获取的 combineReducers，可以将全局状态变成 immutable。

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\reducer.js</span>

```javascript
import { Map } from 'immutable';

import * as actionTypes from './constants';

const defaultState = Map({
  topBanners: []
});

function reducer(state = defaultState, action) {
  switch (action.type) {
    case actionTypes.CHANGE_TOP_BANNERS:
      return state.set("topBanners", action.topBanners);
    default:
      return state;
  }
}

export default reducer;
```

:turtle: 需要通过 set 方法来修改 immutable

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\index.js</span>

```react
import React, { memo } from 'react';
import { useSelector, useDispatch, shallowEqual } from 'react-redux';

import { getTopBannerAction } from './store/actionCreators';

function HYRecommend(props) {
  // 获取 redux 中的状态、dispatch方法
  const { topBanners } = useSelector(state => {
    // topBanners: state.get("recommend").get("topBanners") 与下面等价
    topBanners: state.getIn(["recommend", "topBanners"])
  }, shallowEqual);
  const dispatch = useDispatch();

  useEffect(() => {
    dispatch(getTopBannerAction());
  }, [dispatch])

  return (
    <div>
      <h2>HYRecommend: {topBanners.length}</h2>
    </div>
  )
}

export default memo(HYRecommend);
```

:turtle: 需要通过 get 方法来获取 immutable，或通过其提供的语法糖；

:turtle: 由于全局状态也为 immutable，也不能通过点语法获取属性。



### 实现轮播图

对 recommend/index.js 中的代码进行抽离：逻辑与轮播图组件密切，自己维护更好；

使用 Antd 中的轮播图组件，应用部分 API 

```react
- src 
  + pages
    - discover                   
      + c-pages   
        - recommend              
          + c-cpns                // 子路由组件（新增）
            - top-banner		  // 轮播图组件
              + index.js
              + style.js
          + store                 
            - ...	
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\top-banner\index.js</span>

```react
import React, { memo, useEffect, useRef, useCallback, useState } from 'react';
import { useSelector, useDispatch, shallowEqual } from 'react-redux';

import { getTopBannerAction } from '../../store/actionCreators';

import { Carousel } from 'antd';
import {
  BannerWrapper,
  BannerLeft,
  BannerRight,
  BannerControl
} from './style';

export default memo(function HYTopBanner() {
  // state
  const [currentIndex, setCurrentIndex] = useState(0);

  // redux
  const { topBanners } = useSelector(state => ({
    topBanners: state.getIn(["recommend", "topBanners"])
  }), shallowEqual);
  const dispatch = useDispatch();

  // 引用组件
  const bannerRef = useRef();
  useEffect(() => {
    dispatch(getTopBannerAction());
  }, [dispatch]);

  // 缓存方法
  const bannerChange = useCallback((from, to) => {
    setTimeout(() => {
      setCurrentIndex(to);
    }, 0);
  }, []);

  // 其他业务逻辑
  const bgImage = topBanners[currentIndex] && (topBanners[currentIndex].imageUrl + "?imageView&blur=40x20")

  return (
    <BannerWrapper bgImage={bgImage}>
      <div className="banner wrap-v2">
        <BannerLeft>
          <Carousel effect="fade" autoplay ref={bannerRef} beforeChange={bannerChange}>
            {
              topBanners.map((item, index) => {
                return (
                  <div className="banner-item" key={item.imageUrl}>
                    <img className="image" src={item.imageUrl} alt={item.typeTitle} />
                  </div>
                )
              })
            }
          </Carousel>
        </BannerLeft>
        <BannerRight></BannerRight>
        <BannerControl>
          <button className="btn left" onClick={e => bannerRef.current.prev()}></button>
          <button className="btn right" onClick={e => bannerRef.current.next()}></button>
        </BannerControl>
      </div>
    </BannerWrapper>
  )
})
```

这里由后端实现高斯模糊，具体方式为对应图片路径后拼接特点字符串

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\top-banner\style.js</span>

```less
import styled from 'styled-components';

export const BannerWrapper = styled.div`
  background: url(${props => props.bgImage}) center center/6000px;

  .banner {
    height: 270px;
    background-color: red;

    display: flex;
    position: relative;
  }
`

export const BannerLeft = styled.div`
  width: 730px;

  .banner-item {
    overflow: hidden;
    height: 270px;
    .image {
      width: 100%;
    }
  }
`

export const BannerRight = styled.a.attrs({
  href: "https://music.163.com/#/download",
  target: "_blank"
})`
  width: 254px;
  height: 270px;
  background: url(${require("@/assets/img/download.png")});
`

export const BannerControl = styled.div`
  position: absolute;
  left: 0;
  right: 0;
  top: 50%;
  transform: translateY(-50%);

  .btn {
    position: absolute;
    width: 37px;
    height: 63px;
    background-image: url(${require("@/assets/img/banner_sprite.png")});
    background-color: transparent;
    cursor: pointer;

    &:hover {
      background-color: rgba(0, 0, 0, .1);
    }
  }

  .left {
    left: -68px;
    background-position: 0 -360px;
  }

  .right {
    right: -68px;
    background-position: 0 -508px;
  }
`
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\index.js</span>

```react
import React, { memo } from 'react';

import HYTopBanner from './c-cpns/top-banner';
import { 
  RecommendWrapper
} from './style';

function HYRecommend(props) {
  return (
    <RecommendWrapper>
      <HYTopBanner/>
    </RecommendWrapper>
  )
}

export default memo(HYRecommend);
```



### 实现标题组件

很多组件都需要使用到该组件，故作为公共组件实现。

```elm
- src 
  + components
    - theme-header-rcm            // 标题主题组件
      + index.js
      + style.js
  + pages
    - discover                   
      + c-pages   
        - recommend              
          + c-cpns                // 子路由组件（新增）
            - hot-recommend		  // 热门推荐
              + index.js
              + style.js
            - new-album           // 新碟上架
            - recommend-ranking   //  榜单
          + store                 
            - ...	
```

<span style="backGround: #efe0b9">src\components\theme-header-rcm\index.js</span>

```react
import React, { memo } from 'react';
import PropTypes from 'prop-types';

import { HeaderWrapper } from './style';

const HYThemeHeaderRCM = memo(function(props) {
  // 自定义属性
  const { title, keywords } = props;

  return (
    <HeaderWrapper className="sprite_02">
      <div className="left">
        <h3 className="title">{title}</h3>
        <div className="keyword">
          {
            keywords.map((item, index) => {
              return (
                <div className="item" key={item}>
                  <a href="todo">{item}</a>
                  <span className="divider">|</span>
                </div>
              )
            })
          }
        </div>
      </div>
      <div className="right">
        <a href="todo">更多</a>
        <i className="icon sprite_02"></i>
      </div>
    </HeaderWrapper>
  )
})

// 添加校验和默认值
HYThemeHeaderRCM.propTypes = {
  title: PropTypes.string.isRequired,
  keywords: PropTypes.array
}

HYThemeHeaderRCM.defaultProps = {
  keywords: []
}

export default HYThemeHeaderRCM;
```

<span style="backGround: #efe0b9">src\components\theme-header-rcm\style.js</span>

```less
import styled from 'styled-components';

export const HeaderWrapper = styled.div`
  height: 33px;
  border-bottom: 2px solid #C10D0C;
  padding: 0 10px 4px 34px;
  background-position: -225px -156px;

  display: flex;
  justify-content: space-between;
  align-items: center;

  .left {
    display: flex;
    align-items: center;

    .title {
      font-size: 20px;
      font-family: "Microsoft Yahei", Arial, Helvetica, sans-serif;
      margin-right: 20px;
    }

    .keyword {
      display: flex;

      .item {
        .divider {
          margin: 0 15px;
          color: #ccc;
        }
      }
    }
  }

  .right {
    display: flex;
    align-items: center;
    .icon {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-left: 4px;
      background-position: 0 -240px;
    }
  }
`
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\hot-recommend\index.js</span>

```react
import React, { memo } from 'react';

import HYThemeHeaderRCM from '@/components/theme-header-rcm';
import {
  HotRecommendWrapper
} from './style';

export default memo(function HYHotRecommend() {
  return (
    <HotRecommendWrapper>
      <HYThemeHeaderRCM title="热门推荐" keywords={["华语", "流行", "民谣", "摇滚", "电子"]} />
    </HotRecommendWrapper>
  )
})
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\hot-recommend\style.js</span>

```less
import styled from "styled-components";

export const HotRecommendWrapper = styled.div`
  .recommend-list {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
  }
`
```



<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\new-album\index.js</span>

```react
import React, { memo } from 'react';

import HYThemeHeaderRCM from '@/components/theme-header-rcm';

export default memo(function HYNewAlbum() {
  return (
    <div>
      <HYThemeHeaderRCM title="新碟上架" />
    </div>
  )
})
```



<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\recommend-ranking\index.js</span>

```react
import React, { memo } from 'react';

import HYThemeHeaderRCM from '@/components/theme-header-rcm';

export default memo(function HYRecomendRanking() {
  return (
    <div>
      <HYThemeHeaderRCM title="榜单" />
    </div>
  )
})
```



<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\index.js</span>

```react
import React, { memo } from 'react';

import HYTopBanner from './c-cpns/top-banner';
import HYHotRecommend from './c-cpns/hot-recommend';
import HYNewAlbum from './c-cpns/new-album';
import HYRecommendRanking from './c-cpns/recommend-ranking';
import { 
  RecommendWrapper,
  Content,
  RecommendLeft,
  RecommendRight
} from './style';

function HYRecommend(props) {
  return (
    <RecommendWrapper>
      <HYTopBanner/>
      <Content className="wrap-v2">
        <RecommendLeft>
          <HYHotRecommend/>
          <HYNewAlbum/>
          <HYRecommendRanking/>
        </RecommendLeft>
        <RecommendRight></RecommendRight>
      </Content>
    </RecommendWrapper>
  )
}

export default memo(HYRecommend);
```



### 热门推荐-数据

该项目，网络请求及数据存取都交由 redux 内部实现。

```
1. service 中添加 API
2. 定义 action 的常量名称
3. reducer
4. actionCreators.js 中定义两个action，一个用于网络请求，一个用于改变状态
5. 在业务组件中导入 redux
6. 通过 useEffect 在组件挂载后请求数据；模板中展示状态
```

定义请求实例

<span style="backGround: #efe0b9">src\services\recommend.js</span>

```javascript
import request from './request';

// ...
export function getHotRecommends(limit) {
  return request({
    url: "/personalized",
    params: {
      limit
    }
  })
}
```

定义action名称

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\constants.js</span>

```javascript
// ...
export const CHANGE_HOT_RECOMMEND = "recommend/CHANGE_HOT_RECOMMEND";
```

有个请求参数的值是固定的

<span style="backGround: #efe0b9">src\common\contants.js</span>

```javascript
export const HOT_RECOMMEND_LIMIT = 8;
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\reducer.js</span>

```react
import { Map } from 'immutable';

import * as actionTypes from './constants';

const defaultState = Map({
  // ...
  hotRecommends: []
});

function reducer(state = defaultState, action) {
  switch (action.type) {
    // ...
    case actionTypes.CHANGE_HOT_RECOMMEND:
      return state.set("hotRecommends", action.hotRecommends);
    default:
      return state;
  }
}

export default reducer;
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\actionCreators.js</span>

```javascript
import * as actionTypes from './constants';

import { 
  // ...
  getHotRecommends
} from '@/services/recommend';

// ...
const changeHotRecommendAction = (res) => ({
  type: actionTypes.CHANGE_HOT_RECOMMEND,
  hotRecommends: res.result
})

// ...
export const getHotRecommendAction = (limit) => {
  return dispatch => {
    getHotRecommends(limit).then(res => {
      dispatch(changeHotRecommendAction(res));
    })
  }
}
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\hot-recommend\index.js</span>

```react
import React, { memo, useEffect } from 'react';
import { useDispatch, useSelector, shallowEqual } from 'react-redux';

import { HOT_RECOMMEND_LIMIT } from '@/common/contants';

import HYThemeHeaderRCM from '@/components/theme-header-rcm';
import {
  HotRecommendWrapper
} from './style';
import { getHotRecommendAction } from '../../store/actionCreators';

export default memo(function HYHotRecommend() {
  // redux 
  const { hotRecommends } = useSelector(state => ({
    hotRecommends: state.getIn(["recommend", "hotRecommends"])
  }), shallowEqual);
  const dispatch = useDispatch();

  // other hooks
  useEffect(() => {
    dispatch(getHotRecommendAction(HOT_RECOMMEND_LIMIT));
  }, [dispatch]);

  return (
    <HotRecommendWrapper>
      <HYThemeHeaderRCM title="热门推荐" keywords={["华语", "流行", "民谣", "摇滚", "电子"]} />
      <div className="recommend-list">
        {
          hotRecommends.map((item, index) => {
            return <div>{item.name}</div>
          })
        }
      </div>
    </HotRecommendWrapper>
  )
})
```



### 热门推荐-展示

```elm
- src 
  + components
    - songs-cover           // 热门推荐项组件
      + index.js
      + style.js
  + pages
    - discover                   
      + c-pages   
        - recommend              
          + c-cpns                // 子路由组件（新增）
            - hot-recommend		  // 热门推荐
              + index.js
  + utils
    - format-utils.js
```

<span style="backGround: #efe0b9">src\components\songs-cover\index.js</span>

```react
import React, { memo } from 'react';

import { getCount, getSizeImage } from "@/utils/format-utils";

import { SongsCoverWrapper } from './style';

export default memo(function HYSongsCover(props) {
  const { info } = props;

  return (
    <SongsCoverWrapper>
      <div className="cover-top">
        <img src={getSizeImage(info.picUrl, 140)} alt="" />
        <div className="cover sprite_covor">
          <div className="info sprite_covor">
            <span>
              <i className="sprite_icon erji"></i>
              {getCount(info.playCount)}
            </span>
            <i className="sprite_icon play"></i>
          </div>
        </div>
      </div>
      <div className="cover-bottom text-nowrap">
        {info.name}
      </div>
      <div className="cover-source text-nowrap">
        by {info.copywriter || info.creator.nickname}
      </div>
    </SongsCoverWrapper>
  )
})
```

<span style="backGround: #efe0b9">src\components\songs-cover\style.js</span>

```less
import styled from "styled-components";

export const SongsCoverWrapper = styled.div`
  width: 140px;
  margin: 20px ${props => (props.right || 0)} 20px 0;

  .cover-top {
    position: relative;

    &>img {
      width: 140px;
      height: 140px;
    }
    
    .cover {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-position: 0 0;

      .info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 10px;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-position: 0 -537px;
        color: #ccc;
        height: 27px;

        .erji {
          margin-right: 5px;
          display: inline-block;
          width: 14px;
          height: 11px;
          background-position: 0 -24px;
        }

        .play {
          display: inline-block;
          width: 16px;
          height: 17px;
          background-position: 0 0;
        }
      }
    }
  }

  .cover-bottom {
    font-size: 14px;
    color: #000;
    margin-top: 5px;
  }

  .cover-source {
    color: #666;
  }
`
```

<span style="backGround: #efe0b9">src\utils\format-utils.js</span>

```javascript
export function getCount(count) {
  if (count < 0) return;
  if (count < 10000) {
    return count;
  } else if (Math.floor(count / 10000) < 10000) {
    return Math.floor(count / 1000) / 10 + "万";
  } else {
    return Math.floor(count / 10000000) / 10 + "亿";
  }
}

export function getSizeImage(imgUrl, size) {
  return `${imgUrl}?param=${size}x${size}`;
}
```

:hammer_and_wrench: 服务器对图片进行了处理，正常图片路径后加上特点参数，即可返回对应尺寸图片。

**组件中引入**

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\hot-recommend\index.js</span>

```react
import React, { memo, useEffect } from 'react';
import { useDispatch, useSelector, shallowEqual } from 'react-redux';

import { HOT_RECOMMEND_LIMIT } from '@/common/contants';

import HYThemeHeaderRCM from '@/components/theme-header-rcm';
import HYSongsCover from '@/components/songs-cover';
import {
  HotRecommendWrapper
} from './style';
import { getHotRecommendAction } from '../../store/actionCreators';

export default memo(function HYHotRecommend() {
  // redux 
  const { hotRecommends } = useSelector(state => ({
    hotRecommends: state.getIn(["recommend", "hotRecommends"])
  }), shallowEqual);
  const dispatch = useDispatch();

  // other hooks
  useEffect(() => {
    dispatch(getHotRecommendAction(HOT_RECOMMEND_LIMIT));
  }, [dispatch]);

  return (
    <HotRecommendWrapper>
      <HYThemeHeaderRCM title="热门推荐" keywords={["华语", "流行", "民谣", "摇滚", "电子"]} />
      <div className="recommend-list">
        {
          hotRecommends.map((item, index) => {
            return <HYSongsCover key={item.id} info={item}/>
          })
        }
      </div>
    </HotRecommendWrapper>
  )
})
```



### 新碟上架-数据

```
1. service 中添加 API
2. 定义 action 的常量名称
3. reducer
4. actionCreators.js 中定义两个action，一个用于网络请求，一个用于改变状态
5. 在业务组件中导入 redux
6. 通过 useEffect 在组件挂载后请求数据；模板中展示状态
```

定义请求实例

<span style="backGround: #efe0b9">src\services\recommend.js</span>

```javascript
import request from './request';

// ...
export function getNewAlbums(limit) {
  return request({
    url: "/top/album",
    params: {
      limit
    }
  })
}
```

定义action名称

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\constants.js</span>

```javascript
// ...
export const CHANGE_NEW_ALBUM = "recommend/CHANGE_NEW_ALBUM";
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\reducer.js</span>

```react
import { Map } from 'immutable';

import * as actionTypes from './constants';

const defaultState = Map({
  // ...
  newAlbums: []
});

function reducer(state = defaultState, action) {
  switch (action.type) {
    // ...
    case actionTypes.CHANGE_NEW_ALBUM:
      return state.set("newAlbums", action.newAlbums);
    default:
      return state;
  }
}

export default reducer;
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\actionCreators.js</span>

```javascript
import * as actionTypes from './constants';

import { 
  // ...
  getNewAlbums
} from '@/services/recommend';

// ...
const changeNewRankingAction = (res) => ({
  type: actionTypes.CHANGE_NEW_RANKING,
  newRanking: res.playlist
})

// ...
export const getNewAlbumAction = (limit) => {
  return dispatch => {
    getNewAlbums(limit).then(res => {
      dispatch(changeNewAlbumAction(res));
    })
  }
}
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\new-album\index.js</span>

```react
import React, { memo, useEffect } from 'react';
import { useDispatch, useSelector, shallowEqual } from 'react-redux';

import { getNewAlbumAction } from '../../store/actionCreators';

import HYThemeHeaderRCM from '@/components/theme-header-rcm';
import { AlbumWrapper } from './style';

export default memo(function HYNewAlbum() {
  // redux 
  const { newAlbums } = useSelector(state => ({
    newAlbums: state.getIn(["recommend", "newAlbums"])
  }), shallowEqual);
  const dispatch = useDispatch();

  // 请求数据
  useEffect(() => {
    dispatch(getNewAlbumAction(10));
  }, [dispatch]);

  return (
    <AlbumWrapper>
      <HYThemeHeaderRCM title="新碟上架" />
      <div className="content">
        {
          newAlbums.map((item, index) => {
              return <div key={item.id}>{item.name}</div>
          })
        }
      </div>
    </AlbumWrapper>
  )
})
```



### 新碟上架-轮播

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\new-album\index.js</span>

通过走马灯（轮播图）的方式实现，每页展示 5 个数据项。

```react
import React, { memo, useEffect, useRef } from 'react';
import { useDispatch, useSelector, shallowEqual } from 'react-redux';

import { getNewAlbumAction } from '../../store/actionCreators';

import { Carousel } from 'antd';
import HYThemeHeaderRCM from '@/components/theme-header-rcm';
import { AlbumWrapper } from './style';

export default memo(function HYNewAlbum() {
  // redux 
  const { newAlbums } = useSelector(state => ({
    newAlbums: state.getIn(["recommend", "newAlbums"])
  }), shallowEqual);
  const dispatch = useDispatch();

  // 引用子组件
  const pageRef = useRef();
  // 请求数据
  useEffect(() => {
    dispatch(getNewAlbumAction(10));
  }, [dispatch]);

  return (
    <AlbumWrapper>
      <HYThemeHeaderRCM title="新碟上架" />
      <div className="content">
        <button className="arrow arrow-left sprite_02" 
                onClick={e => pageRef.current.prev()}></button>
        <div className="album">
          <Carousel dots={false} ref={pageRef}>
            {
              [0, 1].map(item => {
                return (
                  <div key={item} className="page">
                    {
                      newAlbums.slice(item * 5, (item + 1) * 5).map(iten => {
                        return <div>{iten.id}</div>
                      })
                    }
                  </div>
                )
              })
            }
          </Carousel>
        </div>
        <button className="arrow arrow-right sprite_02"
                onClick={e => pageRef.current.next()}></button>
      </div>
    </AlbumWrapper>
  )
})
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\new-album\style.js</span>

```less
import styled from "styled-components";

export const AlbumWrapper = styled.div`
  margin-top: 50px;

  .content {
    height: 186px;
    background-color: #f5f5f5;
    border: 1px solid #d3d3d3;
    margin: 20px 0 37px;
    display: flex;
    align-items: center;

    .arrow {
      width: 25px;
      height: 25px;
      cursor: pointer;
    }

    .arrow-left {
      background-position: -260px -75px;
    }

    .arrow-right {
      background-position: -300px -75px;
    }

    .album {
      width: 640px;
      height: 150px;

      .ant-carousel .slick-slide {
        height: 150px;
        overflow: hidden;
      }

      .page {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
      }
    }
  }
`
```



### 新碟上架-项

由于很多地方用到相似的样式，唯一区别在于大小不同；

故写成公共组件，并接收自定义属性（并提供默认值）来自定义图片大小等。

**编写公共组件**

<span style="backGround: #efe0b9">src\components\album-cover\index.js</span>

```react
import React, { memo } from 'react';

import { getSizeImage } from '@/utils/format-utils';

import { AlbumWrapper } from './style';

export default memo(function HYAlbumCover(props) {
  // 父传子
  const { info, size = 130, width = 153, bgp = "-845px" } = props;

  return (
    <AlbumWrapper size={size} width={width} bgp={bgp}>
      <div className="album-image">
        <img src={getSizeImage(info.picUrl, size)} alt="" />
        <a href="/todo" className="cover image_cover">{info.name}</a>
      </div>
      <div className="album-info">
        <div className="name text-nowrap">{info.name}</div>
        <div className="artist text-nowrap">{info.artist.name}</div>
      </div>
    </AlbumWrapper>
  )
})
```

**自定义样式属性值**

<span style="backGround: #efe0b9">src\components\album-cover\style.js</span>

```less
import styled from 'styled-components';

export const AlbumWrapper = styled.div`
  width: ${props => props.width + "px"};

  .album-image {
    position: relative;
    width: ${props => props.width + "px"};
    height: ${props => props.size + "px"};
    overflow: hidden;
    margin-top: 15px;

    img {
      width: ${props => props.size + "px"};
      height: ${props => props.size + "px"};
    }

    .cover {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background-position: 0 ${props => props.bgp};
      text-indent: -9999px;
    }
  }

  .album-info {
    font-size: 12px;
    width: ${props => props.size};
    .name {
      color: #000;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .artist {
      color: #666;
    }
  }
`
```

**引用该组件**

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\new-album\index.js</span>

```react
import React, { memo, useEffect, useRef } from 'react';
import { useDispatch, useSelector, shallowEqual } from 'react-redux';

import { getNewAlbumAction } from '../../store/actionCreators';

import { Carousel } from 'antd';
import HYAlbumCover from '@/components/album-cover';
import HYThemeHeaderRCM from '@/components/theme-header-rcm';
import { AlbumWrapper } from './style';

export default memo(function HYNewAlbum() {
  // hooks
  const { newAlbums } = useSelector(state => ({
    newAlbums: state.getIn(["recommend", "newAlbums"])
  }), shallowEqual);
  const dispatch = useDispatch();

  // other hooks
  const pageRef = useRef();
  useEffect(() => {
    dispatch(getNewAlbumAction(10));
  }, [dispatch]);

  return (
    <AlbumWrapper>
      <HYThemeHeaderRCM title="新碟上架" />
      <div className="content">
        <button className="arrow arrow-left sprite_02" 
                onClick={e => pageRef.current.prev()}></button>
        <div className="album">
          <Carousel dots={false} ref={pageRef}>
            {
              [0, 1].map(item => {
                return (
                  <div key={item} className="page">
                    {
                      newAlbums.slice(item * 5, (item + 1) * 5).map(iten => {
                        return <HYAlbumCover key={iten.id} 
                                             info={iten} 
                                             size={100} 
                                             width={118} 
                                             bgp="-570px"/>
                      })
                    }
                  </div>
                )
              })
            }
          </Carousel>
        </div>
        <button className="arrow arrow-right sprite_02"
                onClick={e => pageRef.current.next()}></button>
      </div>
    </AlbumWrapper>
  )
})
```





### 排行榜-数据

**定义接口**

<span style="backGround: #efe0b9">src\services\recommend.js</span>

```javascript
import request from './request';

// ...
export function getTopList(idx) {
  return request({
    url: "/top/list",
    params: {
      idx
    }
  })
}
```

**定义常量**

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\constants.js</span>

```javascript
// ...
export const CHANGE_UP_RANKING = "recommend/CHANGE_UP_RANKING";
export const CHANGE_NEW_RANKING = "recommend/CHANGE_New_RANKING";
export const CHANGE_ORIGIN_RANKING = "recommend/CHANGE_ORIGIN_RANKING";
```

**定义action**

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\actionCreators.js</span>

```javascript
import * as actionTypes from './constants';

import { getNewAlbums } from '@/services/recommend';

import { 
  // ...
  getTopList
} from '@/services/recommend';

// ...
const changeUpRankingAction = (res) => ({
  type: actionTypes.CHANGE_UP_RANKING,
  upRanking: res.playlist
})

const changeNewRankingAction = (res) => ({
  type: actionTypes.CHANGE_NEW_RANKING,
  newRanking: res.playlist
})

const changeOriginRankingAction = (res) => ({
  type: actionTypes.CHANGE_ORIGIN_RANKING,
  originRanking: res.playlist
})

// ...
export const getTopListAction = (idx) => {
  return dispatch => {
    getTopList(idx).then(res => {
      switch (idx) {
        case 0:
          dispatch(changeUpRankingAction(res));
          break;
        case 2:
          dispatch(changeNewRankingAction(res));
          break;
        case 3:
          dispatch(changeOriginRankingAction(res));
          break;
        default:
      }
    });
  }
}
```

**添加处理逻辑**

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\store\reducer.js</span>

```javascript
import { Map } from 'immutable';

import * as actionTypes from './constants';

const defaultState = Map({
  // ...
  upRanking: {},
  newRanking: {},
  originRanking: {},
});

function reducer(state = defaultState, action) {
  switch (action.type) {
    // ...  
    case actionTypes.CHANGE_UP_RANKING:
      return state.set("upRanking", action.upRanking);
    case actionTypes.CHANGE_NEW_RANKING:
      return state.set("newRanking", action.newRanking);
    case actionTypes.CHANGE_ORIGIN_RANKING:
      return state.set("originRanking", action.originRanking);
    default:
      return state;
  }
}

export default reducer;
```

**结合到组件**

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\recommend-ranking\index.js</span>

```react
import React, { memo, useEffect } from 'react';
import { useDispatch, useSelector, shallowEqual } from 'react-redux';


import HYThemeHeaderRCM from '@/components/theme-header-rcm';
import { RankingWrapper } from './style';
import { getTopListAction } from '../../store/actionCreators';

export default memo(function HYRecomendRanking() {
  // redux hooks
  const { upRanking, newRanking, originRanking } = useSelector(state => ({
    upRanking: state.getIn(["recommend", "upRanking"]),
    newRanking: state.getIn(["recommend", "newRanking"]),
    originRanking: state.getIn(["recommend", "originRanking"]),
  }), shallowEqual);
  const dispatch = useDispatch();

  // other hooks
  useEffect(() => {
    dispatch(getTopListAction(0));
    dispatch(getTopListAction(2));
    dispatch(getTopListAction(3));
  }, [dispatch]);

  return (
    <RankingWrapper>
      <HYThemeHeaderRCM title="榜单" />
      <div className="tops"></div>
    </RankingWrapper>
  )
})
```



### 排行榜-展示

通过背景图片，实现表格的横纹条效果，前端通过 flex 布局让文字均匀布局上去；

在模板中使用的数据，还有通过方法操作时，最好提供初始值，否则容易报错。

**编写组件**

<span style="backGround: #efe0b9">src\components\top-ranking\index.js</span>

```react
import React, { memo } from 'react';
import { useDispatch } from 'react-redux';

import { getSizeImage } from '@/utils/format-utils';
import { getSongDetailAction } from '@/pages/player/store';

import { TopRankingWrapper } from './style';

export default memo(function HYTopRanking(props) {
  // props
  const { info } = props;
  const { tracks = [] } = info;

  // redux
  const dispatch = useDispatch();

  // other handle
  const playMusic = (item) => {
    dispatch(getSongDetailAction(item.id));
  }

  return (
    <TopRankingWrapper>
      <div className="header">
        <div className="image">
          <img src={getSizeImage(info.coverImgUrl)} alt="" />
          <a href="/todo" className="image_cover">ranking</a>
        </div>
        <div className="info">
          <a href="/todo">{info.name}</a>
          <div>
            <button className="btn play sprite_02"></button>
            <button className="btn favor sprite_02"></button>
          </div>
        </div>
      </div>
      <div className="list">
        {
          tracks.slice(0, 10).map((item, index) => {
            return (
              <div key={item.id} className="list-item">
                <div className="rank">{index + 1}</div>
                <div className="info">
                  <span className="name text-nowrap">{item.name}</span>
                  <div className="operate">
                    <button className="btn sprite_02 play" 
                            onClick={e => playMusic(item)}></button>
                    <button className="btn sprite_icon2 addto"></button>
                    <button className="btn sprite_02 favor"></button>
                  </div>
                </div>
              </div>
            )
          })
        }
      </div>
      <div className="footer">
        <a href="/todo">查看全部 &gt;</a>
      </div>
    </TopRankingWrapper>
  )
})
```

<span style="backGround: #efe0b9">src\components\top-ranking\style.js</span>

```less
import styled from 'styled-components';

export const TopRankingWrapper = styled.div`
  flex: 1;

  .header {
    height: 100px;
    display: flex;

    margin: 20px 0 0 20px;

    .image {
      width: 80px;
      height: 80px;
      position: relative;

      img {
        width: 80px;
        height: 80px;
      }
    }

    .info {
      margin: 5px 0 0 10px;

      a {
        font-size: 14px;
        color: #333;
        font-weight: 700;
      }

      .btn {
        display: inline-block;
        text-indent: -9999px;
        width: 22px;
        height: 22px;
        margin: 8px 10px 0 0;
        cursor: pointer;
      }

      .play {
        background-position: -267px -205px;
      }

      .favor {
        background-position: -300px -205px;
      }
    }
  }

  .list {
    .list-item {
      position: relative;
      display: flex;
      align-items: center;
      height: 32px;

      :nth-child(-n+3) .rank {
        color: #c10d0c;
      }

      .rank {
        width: 35px;
        text-align: center;
        margin-left: 10px;
        font-size: 16px;
      }

      .info {
        color: #000;
        width: 170px;
        height: 17px;
        line-height: 17px;
        display: flex;
        justify-content: space-between;

        .name {
          flex: 1;
        }

        .operate {
          display: flex;
          align-items: center;
          display: none;
          width: 82px;

          .btn {
            width: 17px;
            height: 17px;
            margin-left: 8px;
            cursor: pointer;
          }

          .play {
            background-position: -267px -268px;
          }

          .addto {
            position: relative;
            top: 2px;
            background-position: 0 -700px;
          }

          .favor {
            background-position: -297px -268px;
          }
        }
      }

      

      &:hover {
        .operate {
          display: block;
        }
      }
    }
  }

  .footer {
    height: 32px;
    display: flex;
    align-items: center;
    margin-right: 32px;
    justify-content: flex-end;

    a {
      color: #000;
    }
  }
`
```

**使用组件**

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\recommend-ranking\index.js</span>

```react
import React, { memo, useEffect } from 'react';
import { useDispatch, useSelector, shallowEqual } from 'react-redux';

import HYThemeHeaderRCM from '@/components/theme-header-rcm';
import HYTopRanking from '@/components/top-ranking';
import { RankingWrapper } from './style';
import { getTopListAction } from '../../store/actionCreators';

export default memo(function HYRecomendRanking() {
  // redux
  const { upRanking, newRanking, originRanking } = useSelector(state => ({
    upRanking: state.getIn(["recommend", "upRanking"]),
    newRanking: state.getIn(["recommend", "newRanking"]),
    originRanking: state.getIn(["recommend", "originRanking"]),
  }), shallowEqual);
  const dispatch = useDispatch();

  // other hooks
  useEffect(() => {
    dispatch(getTopListAction(0));
    dispatch(getTopListAction(2));
    dispatch(getTopListAction(3));
  }, [dispatch]);

  return (
    <RankingWrapper>
      <HYThemeHeaderRCM title="榜单" />
      <div className="tops">
        <HYTopRanking info={upRanking}/>
        <HYTopRanking info={newRanking}/>
        <HYTopRanking info={originRanking}/>
      </div>
    </RankingWrapper>
  )
})
```

<span style="backGround: #efe0b9">src\pages\discover\c-pages\recommend\c-cpns\recommend-ranking\style.js</span>

```less
import styled from "styled-components";

export const RankingWrapper = styled.div`
  .tops {
    margin: 30px 0;
    display: flex;
    background-image: url(${require("@/assets/img/recommend-top-bg.png")});
    height: 472px;
  }
`
```



### 播放器-状态管理

由于相关的状态比较多，专门设置 reducer 进行管理。

```elm
- src
  + pages
    - player
      + app-player-bar
        - index.js
        - style.js
      + store
        - actionCreators.js
        - constants.js
        - index.js
        - reducer.js
  + store
    - reducer.js                    // 更新
```

**合并新增的状态**

<span style="backGround: #efe0b9">src\store\reducer.js</span>

```react
import { combineReducers } from 'redux-immutable';

import { reducer as recommendReducer } from '../pages/discover/c-pages/recommend/store';
import { reducer as playerReducer } from '../pages/player/store';

const cReducer = combineReducers({
  recommend: recommendReducer,
  player: playerReducer
});

export default cReducer;
```



### 播放器-容器

<span style="backGround: #efe0b9">src\pages\player\app-player-bar\index.js</span>

```react
import React, { memo } from 'react';

import { getSizeImage, formatDate, getPlaySong } from '@/utils/format-utils';

import { NavLink } from 'react-router-dom';
import { Slider } from 'antd';
import {
  PlaybarWrapper,
  Control,
  PlayInfo,
  Operator
} from './style';

export default memo(function HYAppPlayerBar() {
  return (
    <PlaybarWrapper className="sprite_player">
      <div className="content wrap-v2">
        <Control>
          <button className="sprite_player prev"></button>
          <button className="sprite_player play"></button>
          <button className="sprite_player next"></button>
        </Control>
        <PlayInfo>
          <div className="image">
            <a href="/#">
              <img src="xxx" alt="" />
            </a>
          </div>
          <div className="info">
            <div className="song">
              <span className="song-name">红豆</span>
              <a href="#/" className="singer-name">要不要买菜</a>
            </div>
            <div className="progress">
              <Slider defaultValue={30}/>
              <div className="time">
                <span className="now-time">02:30</span>
                <span className="divider">/</span>
                <span className="duration">04:30</span>
              </div>
            </div>
          </div>
        </PlayInfo>
        <Operator>
          <div className="left">
            <button className="sprite_player btn favor"></button>
            <button className="sprite_player btn share"></button>
          </div>
          <div className="right sprite_player">
            <button className="sprite_player btn volume"></button>
            <button className="sprite_player btn loop"></button>
            <button className="sprite_player btn playlist"></button>
          </div>
        </Operator>
      </div>
    </PlaybarWrapper>
  )
});
```

<span style="backGround: #efe0b9">src\pages\player\app-player-bar\style.js</span>

```less
import styled from 'styled-components';

export const PlaybarWrapper = styled.div`
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  height: 52px;
  background-position: 0 0;
  background-repeat: repeat;

  .content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: 0;
    height: 47px;
  }
`

export const Control = styled.div`
  display: flex;
  align-items: center;

  .prev, .next {
    width: 28px;
    height: 28px;
  }

  .prev {
    background-position: 0 -130px;
  }

  .play {
    width: 36px;
    height: 36px;
    margin: 0 8px;
    background-position: 0 ${props => props.isPlaying ? "-165px": "-204px"};
  }

  .next {
    background-position: -80px -130px;
  }
`

export const PlayInfo = styled.div`
  display: flex;
  width: 642px;
  align-items: center;

  .image {
    width: 34px;
    height: 34px;
    border-radius: 5px;
  }

  .info {
    flex: 1;
    color: #a1a1a1;
    margin-left: 10px;

    .song {
      color: #e1e1e1;
      position: relative;
      top: 8px;
      left: 8px;

      .singer-name {
        color: #a1a1a1;
        margin-left: 10px;
      }
    }

    .progress {
      display: flex;
      align-items: center;

      .ant-slider {
        width: 493px;
        margin-right: 10px;

        .ant-slider-rail {
          height: 9px;
          background: url(${require("@/assets/img/progress_bar.png")}) right 0;
        }

        .ant-slider-track {
          height: 9px;
          background: url(${require("@/assets/img/progress_bar.png")}) left -66px;
        }

        .ant-slider-handle {
          width: 22px;
          height: 24px;
          border: none;
          margin-top: -7px;
          background: url(${require("@/assets/img/sprite_icon.png")}) 0 -250px;
        }
      }

      .time {
        .now-time {
          color: #e1e1e1;
        }
        .divider {
          margin: 0 3px;
        }
      }
    }
  }
`

export const Operator = styled.div`
  display: flex;
  position: relative;
  top: 5px;

  .btn {
    width: 25px;
    height: 25px;
    cursor: pointer;
  }

  .favor {
    background-position: -88px -163px;
  }

  .share {
    background-position: -114px -163px;
  }

  .right {
    width: 126px;
    padding-left: 13px;
    background-position: -147px -248px;
    
    .volume {
      background-position: -2px -248px;
    }

    .loop {
      background-position: ${props => {
        switch(props.sequence) {
          case 1:
            return "-66px -248px"
          case 2:
            return "-66px -344px"
          default:
            return "-3px -344px"
        }
      }};
    }

    .playlist {
      width: 59px;
      background-position: -42px -68px;
    }
  }
`
```



### 播放器-其它

format-utils



app-player-bar

- index.js



使用原生 audio 标签控制音乐

获取引用

设置音乐源

开始、暂停

通过回调监听进度，当前时间

设置进度



通过css展示动态同图片

传递给自定义组件/UI组件的回调事件，使用 useCallback 优化性能



另一个页面的壳

player

- index.js 

要添加到路由（player）



添加事件

top-ranking

- index.js



css中使用 switch 等 js 表达式

正则获取时间、歌词



### 优化-懒加载

<span style="backGround: #efe0b9">src\router\index.js</span>

```react
import React from 'react';
import { Redirect } from "react-router-dom";

const HYDiscover = React.lazy(() => import("@/pages/discover"));
const HYRecommend = React.lazy(_ => import("../pages/discover/c-pages/recommend"));
const HYRanking = React.lazy(_ => import("../pages/discover/c-pages/ranking"));
const HYSongs = React.lazy(_ => import("../pages/discover/c-pages/songs"));
const HYDjradio = React.lazy(_ => import("../pages/discover/c-pages/djradio"));
const HYArtist = React.lazy(_ => import("../pages/discover/c-pages/artist"));
const HYAlbum = React.lazy(_ => import("../pages/discover/c-pages/album"));
const HYPlayer = React.lazy(_ => import("../pages/player"));

const HYFriend = React.lazy(_ => import("../pages/friend"));
const HYMine = React.lazy(_ => import("../pages/mine"));

const routes = [
  {
    path: "/",
    exact: true,
    render: () => (
      <Redirect to="/discover"/>
    )
  },
  {
    path: "/discover",
    component: HYDiscover,
    routes: [
      {
        path: "/discover",
        exact: true,
        render: () => (
          <Redirect to="/discover/recommend"/>
        )
      },
      {
        path: "/discover/recommend",
        component: HYRecommend
      },
      {
        path: "/discover/ranking",
        component: HYRanking
      },
      {
        path: "/discover/songs",
        component: HYSongs
      },
      {
        path: "/discover/djradio",
        exact: true,
        component: HYDjradio
      },
      {
        path: "/discover/artist",
        component: HYArtist
      },
      {
        path: "/discover/album",
        component: HYAlbum
      },
      {
        path: "/discover/player",
        component: HYPlayer
      }
    ]
  },
  {
    path: "/mine",
    component: HYMine
  },
  {
    path: "/friend",
    component: HYFriend
  },
];

export default routes;
```

<span style="backGround: #efe0b9">src\App.js</span>

```react
import React, { memo, Suspense } from 'react';
import { Provider } from 'react-redux';
import { renderRoutes } from 'react-router-config';

import routes from './router';
import store from './store';

import { HashRouter } from 'react-router-dom';
import HYAppHeader from '@/components/app-header';
import HYAppFooter from '@/components/app-footer';
import HYAppPlayerBar from './pages/player/app-player-bar';

export default memo(function App() {
  return (
    <Provider store={store}>
      <HashRouter>
        <HYAppHeader />
        <Suspense fallback={<div>page loading</div>}>
          {renderRoutes(routes)}
        </Suspense>
        <HYAppFooter />
        <HYAppPlayerBar/>
      </HashRouter>
    </Provider>
  )
})
```



