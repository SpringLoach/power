## 栗子

### vue3-antd-admin

:whale: 源文件可参考 `../vue.config.js/vue.config.js`

<span style="color: #3a84aa">涉及功能</span>

- 读取 package.json，获取其中的信息

- 记录最后修改时间

- 将信息保存到全局变量

- 判断环境，兼容式

<span style="backGround: #efe0b9">vue.config.js</span>

```javascript
const path = require('path');
const { defineConfig } = require('@vue/cli-service');
const webpack = require('webpack');
const SpeedMeasurePlugin = require('speed-measure-webpack-plugin');
const dayjs = require('dayjs');
const TerserPlugin = require('terser-webpack-plugin');

const resolve = (dir) => path.join(__dirname, dir); // 定义拼接路径的方法
const pkg = require('./package.json');

process.env.VUE_APP_VERSION = pkg.version;

// 判断环境，兼容
const IS_PROD = ['production', 'prod'].includes(process.env.NODE_ENV);
const IS_DEV = ['development'].includes(process.env.NODE_ENV);

// 设置开发环境的端口
const port = process.env.port || process.env.npm_config_port || 8098;

const __APP_INFO__ = {
  pkg,
  lastBuildTime: dayjs().format('YYYY-MM-DD HH:mm:ss'),
};

module.exports = defineConfig({
  publicPath: process.env.BASE_URL,
  productionSourceMap: false, // 是否在生产环境开启资源映射
  css: {
    loaderOptions: {
      less: {
        lessOptions: {
          javascriptEnabled: true, // 不开启可能导致引入antd样式报错
          modifyVars: {}, // 可以声明一些变量
        },
        // 自动 import，可以不用在项目里全局导入（声明变量）
        additionalData: `
          @import "ant-design-vue/lib/style/themes/default.less";
          @import "~@/styles/variables.less";
      `,
      },
    },
  },
  chainWebpack: (config) => {
    // 移除 preload 插件
    config.plugins.delete('preload');
    // 移除 prefetch 插件
    config.plugins.delete('prefetch');

    // 配置开发环境的资源映射方式
    config
      // https://webpack.js.org/configuration/devtool/#development
      .when(IS_DEV, (config) => config.devtool('cheap-source-map'));

    // 配置路径别名
    config.resolve.alias.set('@', resolve('src'));
    config.resolve.alias.set('vue-i18n', 'vue-i18n/dist/vue-i18n.cjs.js');

    // 配置文档标题,tap用于修改参数
    config.plugin('html').tap((args) => {
      args[0].title = 'vue3-antd-admin管理系统';
      return args;
    });

    // 配置相关loader，支持修改，添加和替换相关的loader
    config.module
      .rule('css')
      .exclude.add(resolve('node_modules/ant-design-vue/dist/antd.dark.css')) // 往排除里添加
      .end(); // add完上下文进入了数组，使用end回退
    config.module.rule('raw-css').resourceQuery(/raw/).type('asset/source');

    // 忽略解析markdown文件
    config.module.noParse(/\.md$/);
    if (IS_PROD) {
      config.module
        .rule('md')
        .test(/\.md$/)
        .type('javascript/auto')
        .use('asset') // 添加loader
        .loader('asset') // 切换上下文到loader
        .options({
          limit: 100,
          esModule: false,
          generator: () => '',
        }); //指定选项
    }

    // svg rule loader(排除原处理，否则会被转成base64；添加loader处理，凑成雪碧图)
    config.module.rule('svg').exclude.add(resolve('src/assets/icons')).end();

    config.module
      .rule('icons')
      .test(/\.svg$/)
      .include.add(resolve('src/assets/icons'))
      .end()
      .use('svg-sprite-loader')
      .loader('svg-sprite-loader')
      .options({
        symbolId: 'svg-icon-[name]',
      });

    // 生产环境下的配置
    config.when(IS_PROD, (config) => {
      // split
      config.optimization.splitChunks({
        chunks: 'all', //指定哪些模块需要打包
        cacheGroups: {
          libs: {
            name: 'chunk-libs',
            test: /[\\/]node_modules[\\/]/,
            priority: 10,
            chunks: 'initial', // only package third parties that are initially dependent
          },
          // 将ant design vue（较大的依赖）拆分为单个包，命名为chunk-ant-design-vue
          antdv: {
            name: 'chunk-ant-design-vue',
            priority: 20, // 为了单独抽离为第三方库，优先级需要设得更高
            test: /[\\/]node_modules[\\/]_?ant-design-vue(.*)/, // in order to adapt to cnpm
          },
          commons: {
            name: 'chunk-commons',
            test: resolve('src/components'), // 自定义匹配规则
            minChunks: 3, // 被引用3次就提取出来
            priority: 5, // 优先级（当某个模块同时符合几个规则时，取优先级高者）
            reuseExistingChunk: true, // 是否复用已经从原代码块中分割出来的模块
          },
        },
      });
      config.cache({
        // 将缓存类型设置为文件系统,默认是memory
        type: 'filesystem', // 能开启持久缓存（第二次以后的构建，提速很多倍）
        buildDependencies: {
          // 更改配置文件时，重新缓存
          config: [__filename],
        },
      });
      // 避免文件的频繁变更导致浏览器缓存失效，配置项不理解
      // https:// webpack.js.org/configuration/optimization/#optimizationruntimechunk
      config.optimization.runtimeChunk('single');
    });
  },
  configureWebpack: (config) => {
    // 开启顶级await
    // https://blog.csdn.net/frontend_frank/article/details/114505336
    config.experiments = {
      topLevelAwait: true,
    };
    // 模块在root及默认路径下都未找到时的最终查找路径
    config.resolve.fallback = { path: require.resolve('path-browserify') };
    // 可以在script setup中声明组件名字等，ts需要在同时从tsconfig.json追加配置
    // use defineOptions https://github.com/sxzz/unplugin-vue-define-options
    config.plugins.push(require('unplugin-vue-define-options/webpack')());
    // 打包速度分析
    config.plugins.push(new SpeedMeasurePlugin());

    config.plugins.push(
      // 定义全局变量
      new webpack.DefinePlugin({
        __APP_INFO__: JSON.stringify(__APP_INFO__),
      }),
    );
    if (IS_PROD) {
      // terser-webpack-plugin (https://webpack.docschina.org/plugins/terser-webpack-plugin/);
      const TerserPluginIndex = config.optimization.minimizer.findIndex(
        (n) => n.__pluginName === 'terser',
      );
      config.optimization.minimizer[TerserPluginIndex] = new TerserPlugin({
        terserOptions: {
          warnings: false,
          format: {
            comments: false,
          },
          compress: {
            drop_debugger: true, // remove debugger
            drop_console: true, // 注释console
            pure_funcs: ['console.log'], // 移除console
          },
        },
        extractComments: false, // 是否将注释提取到一个单独的文件中
        parallel: true, // 是否并⾏打包
      });
    }
  },
  devServer: {
    port,
    client: {
      progress: true,
    },
    proxy: {
      '^/api': {
        // target: process.env.VUE_APP_API_URL,
        target: 'https://nest-api.buqiyuan.site/api/',
        changeOrigin: true,
        logLevel: 'debug',
        pathRewrite: {
          '^/api': '',
        },
      },
      '^/ws-api': {
        target: 'wss://nest-api.buqiyuan.site',
        changeOrigin: true, //是否允许跨域
        wss: true,
        logLevel: 'debug',
      },
    },
    // 定义 mock 接口数据
    setupMiddlewares: require('./src/mock/mock-server.js'),
  },
});
```



### 来源网络

> 跟 ant-design-pro 的配置极度相似，cdn引入在html的写法可以去参考。

```javascript
const path = require('path')
const webpack = require('webpack')
const createThemeColorReplacerPlugin = require('./config/plugin.config')

function resolve (dir) {
  return path.join(__dirname, dir)
}

const isProd = process.env.NODE_ENV === 'production'

const assetsCDN = {
  // webpack build externals
  externals: {
    vue: 'Vue',
    'vue-router': 'VueRouter',
    vuex: 'Vuex',
    axios: 'axios'
  },
  css: [],
  // https://unpkg.com/browse/vue@2.6.10/
  js: [
    '//cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js',
    '//cdn.jsdelivr.net/npm/vue-router@3.1.3/dist/vue-router.min.js',
    '//cdn.jsdelivr.net/npm/vuex@3.1.1/dist/vuex.min.js',
    '//cdn.jsdelivr.net/npm/axios@0.19.0/dist/axios.min.js'
  ]
}

// vue.config.js
const vueConfig = {
  configureWebpack: {
    // webpack plugins
    plugins: [
      // Ignore all locale files of moment.js
      new webpack.IgnorePlugin(/^\.\/locale$/, /moment$/)
    ],
    // if prod, add externals
    externals: isProd ? assetsCDN.externals : {}
  },

  chainWebpack: (config) => {
    config.resolve.alias
      .set('@$', resolve('src'))

    const svgRule = config.module.rule('svg')
    svgRule.uses.clear()
    svgRule
      .oneOf('inline')
      .resourceQuery(/inline/)
      .use('vue-svg-icon-loader')
      .loader('vue-svg-icon-loader')
      .end()
      .end()
      .oneOf('external')
      .use('file-loader')
      .loader('file-loader')
      .options({
        name: 'assets/[name].[hash:8].[ext]'
      })

    // if prod is on
    // assets require on cdn
    if (isProd) {
      config.plugin('html').tap(args => {
        args[0].cdn = assetsCDN
        return args
      })
    }
  },

  css: {
    loaderOptions: {
      less: {
        modifyVars: {
          'primary-color': '#1890FF',
          'layout-color': '#1890FF',
          'border-radius-base': '2px'
        },
        // DO NOT REMOVE THIS LINE
        javascriptEnabled: true
      }
    }
  },

  devServer: {
    port: 81,
    proxy: {
      '/api': {
        target: process.env.VUE_APP_API_BASE_URL,
        ws: false,
        changeOrigin: true,
        pathRewrite: {
          '^/api': '' // 需要rewrite的,
        }
      }
    }
  },

  // disable source map in production
  productionSourceMap: false,
  lintOnSave: undefined,
  // babel-loader no-ignore node_modules/*
  transpileDependencies: []
}

// preview.pro.loacg.com only do not use in your production;
if (process.env.VUE_APP_PREVIEW === 'true') {
  // eslint-disable-next-line no-labels
  // runtimeCompiler: true,
  // add `ThemeColorReplacer` plugin to webpack plugins
  vueConfig.configureWebpack.plugins.push(createThemeColorReplacerPlugin())
}

module.exports = vueConfig
```

## webpack-chain

> 流式[配置方案](https://juejin.cn/post/6950076780669566983#heading-15)。它有两个核心的对象：**ChainedMap**和**ChainedSet**。

- 带有明晰注释的[栗子](http://events.jianshu.io/p/30e8f820bfb8)



#### ChainMap

> 如果一个属性被标记为`ChainMap`，它会有一些额外的方法，并且允许这些链式调用。

```javascript
// 清空当前 Map 的所有属性
clear()
// 通过键值从 Map 移除单个配置.
delete(key)
// Map中是否存在一个配置值的特定键，返回真或假
has(key)
// 返回 Map中已存储的所有值的数组
values()
//  提供一个对象，这个对象的属性和值将映射进 Map。第二个参数为一个数组，表示忽略哪些属性
merge(obj, omit)
// handler: ChainedMap => ChainedMap
// 一个把ChainedMap实例作为单个参数的函数
batch(handler)
// condition: Boolean
// whenTruthy: ChainMap -> any, 条件为真时执行
// whenFalsy: ChainSet -> any, 条件为假时执行
when(condition, whenTruthy, whenFalsy)
// 获取 Map 中相应键的值
get(key)
// 先调用 get，如果找不到对应的值, 就返回 fn 函数返回的结果
getOrCompute(key, fn)
// 配置键值对
set(key, value)
```



#### ChainedSet

> 用于操作数组类型的属性。

```javascript
// 末尾增加一个值
add(value)
// 在开始位置增加一个值
prepend(value)
// 清空 set 内容
clear()
// 删除某个值
delete(value)
// 判断是否有某个值
has(value)
// 返回值列表
values()
// 合并给定的数组到 Set 尾部。
merge(arr)
// handler: ChainSet => ChainSet
// 一个把 ChainSet 实例作为单个参数的函数
batch(handler)
// condition: Boolean
// whenTruthy: ChainSet -> any, 条件为真时执行
// whenFalsy: ChainSet -> any, 条件为假时执行
when(condition, whenTruthy, whenFalsy)
```



### 速写记法

> 对于 `ChainMap`，有这样一种简化的写法。

```javascript
devServer.hot(true);

// 上述方法等效于:
devServer.set('hot', true);
```



### 配置例子

> 可以依次配置 `resolve`、`entry`、`output`、`module`、`plugins`、`optimization` 对象。



#### entry 和 output

```javascript
config.entryPoints.clear() // 会把默认的入口清空
config.entry('entry1').add('./src/index1.tsx')//新增入口
config.entry('entry2').add('./src/index2.tsx')//新增入口

config.output
      .path("dist")
      .filename("[name].[chunkhash].js")
      .chunkFilename("chunks/[name].[chunkhash].js")
      .libraryTarget("umd")
```



#### alias

> 配置路径别名

```javascript
config.resolve.alias
  .set('assets',resolve('src/assets'))
  .set('components',resolve('src/components'))
  .set('static',resolve('src/static'))
  .delete('static') // 删掉指定的别名
```



#### plugins

##### 1. 添加一个插件

```javascript
// 先指定名字(这个名字是自定义的)，然后通过 use 添加插件
config
  .plugin(name)
  .use(WebpackPlugin, args)
```

> 保证name的唯一性，避免出现覆盖的情况。

**栗子**

```javascript
const ExtractTextPlugin = require('extract-text-webpack-plugin');

// 先指定名字(这个名字可以自定义)，然后通过 use 添加插件，use 的第二个参数为插件参数，必须是一个数组，也可以不传
config.plugin('extract')
  .use(ExtractTextPlugin, [{
    filename: 'build.min.css',
    allChunks: true,
  }])
```



##### 2. 移除插件

> 通过指定到插件的 `name` 进行移除。

```javascript
config.plugins.delete('extract')
```



##### 3. 指定插件的调用顺序

> 指定 html-webpack-plugin 这个插件在 extract 插件之前执行。

```javascript
const htmlWebpackPlugin = require('html-webpack-plugin');

config.plugin('html')
  .use(htmlWebpackPlugin)
  .before('extract')
```

> 指定 html-webpack-plugin 这个插件在 extract 插件之后执行。

```javascript
config.plugin('html')
  .use(htmlWebpackPlugin)
  .after('extract')
```



##### 4. 动态修改插件参数

```javascript
// 使用 tap 方法修改参数
config
  .plugin(name)
  .tap(options => {
      // 修改它的选项...
      // 可以对这里的options进行配置
      return options;
  })
```



##### 5. 修改插件初始化过程

```javascript
// 通过 init 方法，返回一个实例，这将代替原有的实例化过程
config
  .plugin(name)
  .init((Plugin, args) => new Plugin(...args));
```



#### loader

##### 1. 添加一个 loader

```elm
config.module
  .rule(name)
    .use(name)
      .loader(loader)
      .options(options)
```

**栗子**

```javascript
config.module
  .rule('ts')
  .test(/\.tsx?/)
  .use('ts-loader')
    .loader('ts-loader')
    .options({
      transpileOnly: true
    })
    .end()
```



##### 2. 修改 loader 参数

```javascript
// 通过 tap 方法修改 loader 的参数
config.module
  .rule('ts')
  .test(/\.tsx?/)
  .use('ts-loader')
    .loader('ts-loader')
    .tap(option => {
      // 一系列
      return options;
    })
    .end()
```



##### 3. 移除一个 loader

```javascript
// 通过 uses 对象的 delete 方法，根据 loader 的 name 删除
config.module
  .rule('ts')
  .test(/\.tsx?/)
  .uses.delete('ts-loader')
```



#### optimization

> 这里以其中的 `splitChunks` 和 `minimizer` 为例来配置

```javascript
config.optimization.splitChunks({
     chunks: "async",
     minChunks: 1, // 最小 chunk ，默认1
     maxAsyncRequests: 5, // 最大异步请求数， 默认5
     maxInitialRequests : 3, // 最大初始化请求数，默认3
     cacheGroups:{ // 这里开始设置缓存的 chunks
         priority: 0, // 缓存组优先级
         vendor: { // key 为entry中定义的 入口名称
             chunks: "initial", // 必须三选一： "initial" | "all" | "async"(默认就是async)
             test: /react|vue/, // 正则规则验证，如果符合就提取 chunk
             name: "vendor", // 要缓存的 分隔出来的 chunk 名称
             minSize: 30000,
             minChunks: 1,
         }
     }
});

// 添加一个 minimizer
config.optimization
  .minimizer('css')
  .use(OptimizeCSSAssetsPlugin, [{ cssProcessorOptions: {} }])
// 移除 minimizer
config.optimization.minimizers.delete('css')
// 修改 minimizer 插件参数
config.optimization
  .minimizer('css')
  .tap(args => [...args, { cssProcessorOptions: { safe: false } }])
```



#### 善用条件配置

> 在某些很多场景下取代 if-else，保持配置的链式调用，让代码更加优雅。

```javascript
config.when(
  process.env.NODE === 'production',
  config.plugin('size').use(SizeLimitPlugin)
)
```



## --待整理--

#### 封装自定义组件引入svg

https://www.jianshu.com/p/3accd17be50b

vue3-ant-admin项目就是这样操作的，非常相似。



#### [svg-sprite-loader](https://segmentfault.com/a/1190000017548398)

> 把所有的svg打包成一张雪碧图，引入起来更简单，也减少网络请求数量。



#### 拆分规则

[配置介绍](https://www.jianshu.com/p/27ea80367a2b)、

[分包策略](https://www.jianshu.com/p/d26d7d46b759) 与vue3-antd-admin项目相似



#### 待整理插件

https://blog.csdn.net/Mr_RedStar/article/details/123462435



#### 查看最终配置结果

> 项目下运行

```elm
vue inspect --mode=production > output.js
```



#### mock 接口数据

https://blog.csdn.net/Moonoly/article/details/124554616





#### 常见插件

| 名称                  | **描述**           | --   |
| --------------------- | ------------------ | ---- |
| WebpackBundleAnalyzer | 模块依赖的可视化   |      |
| SpeedMeasurePlugin    | 分析打包各操作耗时 |      |



#### 性能优化

| 操作                                                         | 描述                                           | --   |
| ------------------------------------------------------------ | ---------------------------------------------- | ---- |
| [移除](https://blog.csdn.net/qq_39025670/article/details/110951945) preload 与 prefetch | vue 脚手架默认开启，对于大项目，很影响首屏加载 |      |
| [移除](https://blog.csdn.net/qq_39025670/article/details/110951945) console.log | 使用 terser-webpack-plugin                     | 生产 |
| [开启](https://blog.csdn.net/qq_39025670/article/details/110951945) gzip 压缩 | 使用 compression-webpack-plugin                |      |
| CND [引入](https://blog.csdn.net/qq_39025670/article/details/110951945) | 大幅度减少包体积，用户更快获取资源             |      |



#### 配置资源分析插件

```javascript
module.exports = {
  chainWebpack: config => {
    if (process.env.NODE_ENV === 'production') {
      config
        .plugin('webpack-bundle-analyzer')
        .use(require('webpack-bundle-analyzer').BundleAnalyzerPlugin)
    }
  }
}
```



#### 参考

[Webpack 5 的入门配置及使用](https://juejin.cn/post/7099085545006956551)

- 部分介绍 source - map
- 自动清理 clean-webpack-plugin



[环境配置](https://blog.csdn.net/CEZLZ/article/details/108100460)

.env的配置，覆盖全局

.env非必须，参考项目



[webpack5详细教程（5.68.0版本](https://juejin.cn/post/7014466035923288072#heading-12)

路由懒加载

内容哈希

编译前后全局变量

开启gzip压缩

优化和压缩CSS

防止将外部资源包打包到自己的bundle中



[学习 Webpack5 之路（实践篇）](https://juejin.cn/post/6991774994552324133#heading-6)



[学习 Webpack5 之路（优化篇）- 近 7k 字](https://juejin.cn/post/6996816316875161637#heading-13)

- 查看优化相关插件

- 更细粒度介绍插件等



[十连问](https://juejin.cn/post/7002839760792190989)



