### 上传图片（头像）

#### 官方示例

```vue
<block v-if="imageSrc">
    <image :src="imageSrc" class="image" mode="widthFix"></image>
</block>
<block v-else>
    <view class="uni-hello-addfile" @click="chooseImage">+ 选择图片</view>
</block>
```

```javascript
chooseImage: function() {
    uni.chooseImage({
        count: 1,                        // 最多可以选择的图片张数
        sizeType: ['compressed'],		 // 压缩图，['original']代表原图
        sourceType: ['album'],			 // 从相册选图
        success: (res) => {				 // 成功则返回图片的本地文件路径列表 	
            console.log('chooseImage success, temp path is', res.tempFilePaths[0])
            var imageSrc = res.tempFilePaths[0]
            uni.uploadFile({
                url: 'https://unidemo.dcloud.net.cn/upload',  // 开发者服务器 
                filePath: imageSrc,							  // 要上传文件资源的路径
                fileType: 'image',							  // 文件类型
                name: 'data',								  // key, 开发者在服务器端通过这个键可以获取到文件二进制内容
                success: (res) => {
                    console.log('uploadImage success, res is:', res)
                    uni.showToast({
                        title: '上传成功',
                        icon: 'success',
                        duration: 1000						  // 提示的延迟时间
                    })
                    this.imageSrc = imageSrc
                },
                fail: (err) => {
                    console.log('uploadImage fail', err);
                    uni.showModal({
                        content: err.errMsg,
                        showCancel: false					 // 不显示取消按钮
                    });
                }
            });
        },
        fail: (err) => {
            console.log('chooseImage fail', err)
            // #ifdef MP								    // 小程序集结
            uni.getSetting({
                success: (res) => {							// 成功会返回用户授权结果
                    let authStatus = res.authSetting['scope.album'];
                    if (!authStatus) {
                        uni.showModal({
                            title: '授权失败',
                            content: 'Hello uni-app需要从您的相册获取图片，请在设置界面打开相关权限',
                            success: (res) => {
                                if (res.confirm) {
                                    uni.openSetting()       // 调起客户端小程序设置界面
                                }
                            }
                        })
                    }
                }
            })
            // #endif
        }
    })
}
```



#### starthope

> 可以在牛尾的 `supplement_apply.vue` 和 `batch_upload_attached_pic.vue` 中找到实际情景。



1. 首先仍会调用 `uni.chooseImage`，但在它的成功回调中不再调用 `uni.uploadFile` ，而是调用自己的请求方法，上传成功后，会在当前页面重新请求图片数据。
2. 在将图片上传至服务器前，判断当前已有的图片数量是否超额，来应对图片超出容量上限的情况。
3. 在将图片上传至服务器前，还会判断图片路径是否重复。



### 选择地点

> 对于用户，场景接近于在滴滴平台选择目的地。

```javascript
choosePosition(){
  uni.chooseLocation({
    success(res) {
      console.log(res.name);     // 天安门
      console.log(res.address);  // 北京市东城区东长安街
    }
  })
}
```





### 打卡时间相关业务

```javascript
data() {
    return {
        currentTime:'',  // 当前时间
        currentDate:'',  // 当前日期
        dateType:'无',   // 日期类型
        clockType:'无',  // 打卡类型
        clockTimes:'0', // 打卡次数
    };
},
onShow() {
    let cDate = new Date();
    this.getSignSetting(cDate);  // 获取用户的打卡设置，将从服务器返回日期类型、打卡类型、打卡次数
    this.currentDate = dateUtil.getDate(cDate);                 // 2021/11/15
    this.currentTime = dateUtil.getTimeStr(cDate,"-",true);     // 09:54:04
    setInterval(()=>{
        let date = new Date();
        this.currentTime = dateUtil.getTimeStr(date,"-",true);
    }, 1000);
},					
```



### date.util.js

#### getDateStr

> 将时间对象转换为 `2021-11-15` 形式，分隔符可自定义。

| 步骤 | 说明                           |
| ---- | ------------------------------ |
| ①    | 验证传入值为日期               |
| ②    | 转化字符串类型的日期           |
| ③    | 判断分隔符使用自定义的还是默认 |
| ④    | 分别获得年月日                 |
| ⑤    | 与分隔符拼接返回               |

```javascript
const getDateStr = function(date, separator){
	if(date===""||date===undefined){
		return "";
	}
	if(typeof date=="string"){
		date = stringToDate(date,separator);
	}
	separator = separator?separator:"-";
	
	let year = date.getFullYear();
	let month = date.getMonth()+1<10?'0'+(date.getMonth()+1):date.getMonth()+1;
	let day = date.getDate()<10?'0'+date.getDate():date.getDate();
	
	var strDate = year+separator+month+separator+day;  
	return strDate;
};
```



#### getTimeStr

> 将时间对象或特定字符串转换为 `09:54:04` 形式，可设置是否添加秒。

| 步骤 | 说明                                                   |
| ---- | ------------------------------------------------------ |
| ①    | 如果传入的是字符串，调用 `stringToDate` 转化为日期对象 |
| ②    | 从日期对象分别获取时分秒，根据需求决定是否拼接上秒     |

```javascript
const getTimeStr = function(date,separator,isContainSecond){
	if(date===""||date===undefined){
		return "";
	}
	if(typeof date=="string"){
		date = stringToDate(date,separator);
	}
    isContainSecond = isContainSecond?isContainSecond:true;
    
	let hour = date.getHours();
	hour = hour<10?"0"+hour:hour;
	let minute = date.getMinutes();
	minute = minute<10?"0"+minute:minute;
	let second = date.getSeconds();
	second = second<10?"0"+second:second;
	
	let timeStr = hour+":"+minute;
	if(isContainSecond){
		timeStr+=":"+second;
	}
	return timeStr;
};
```



#### getDate

> 将时间对象或特定字符串转换为 `2021/11/15` 形式。

| 步骤 | 说明                                                         |
| ---- | ------------------------------------------------------------ |
| ①    | 如果传入的是字符串，截取前10个字符。格式必须严格匹配，即补0位 |
| ②    | 否则调用 `getDateStr`                                        |
| ③    | 字符串类型参数会被这个方法处理，而不会传到下一个方法中       |

```javascript
const getDate = function(cdate){
	if(cdate==undefined){
		return
	}
	if(typeof cdate=="string"){
		cdate = cdate.replace(/-/g,"/");
		cdate = cdate.substr(0,10);
		return cdate;
	}
	return getDateStr(cdate,"/");
};
getDate('2021-04-15 10:14:13');  // '2021/04/15'
```



#### stringToDate

> 将特定格式的字符串转化为日期对象。

| 步骤 | 说明                                                         |
| ---- | ------------------------------------------------------------ |
| ①    | 传入的字符串格式必须为 `'2021-11-15'` 或者 `'2021-11-15 10:14:13'` |
| ②    | 将输出日期对象，如 `Mon Nov 15 2021 10:14:13 GMT+0800 (中国标准时间)` |
| ③    | 验证传入值为日期                                             |
| ④    | 判断分隔符使用自定义的还是默认，将根据该分隔符从字符串获取时间参 |
| ⑤    | 对于格式2，还需要额外去获取时分秒，用于创建日期对象          |
| ⑥    | 与分隔符拼接返回                                             |

```javascript
const stringToDate = function(dateStr,separator){
	if(date===""||date===undefined){
		return "";
	}
    separator = separator?separator:"-";
	 
	let year,month,day,hour,minute,second;
	 
	let dateParts = dateStr.split(" ");	 
	let dateArr = dateParts[0].split(separator);
    
	year = parseInt(dateArr[0]);
	month = parseInt(dateArr[1]);
	day = parseInt(dateArr[2]);
    
	if(dateParts.length==1){
		return new Date(year,month -1,day);
	}else{
		let timeArr = dateParts[1].split(":");
		hour = parseInt(timeArr[0]);
		minute = parseInt(timeArr[1]);
		second = parseInt(timeArr[2]);
		return new Date(year,month -1,day,hour,minute,second);
	}
 };
```



### 两日期相差天数

> 下面的方法只返回了天数，也可以返回更具体的时间。
>
> 单独调用new Date()会显示格式 `Mar 31 10:10:43 UTC+0800 2012`；但是用new Date() 参与计算会自动转换为从1970.1.1开始的毫秒数。

```javascript
let startData = new Date("2000-01-02");
let endDate = new Date("2000-01-20");

var days = getDiffDays(new Date(startData), new Date(endDate));
```

```javascript
const getDiffDays = function(startData,endDate){
    //相差的总秒数
    let totalSeconds = parseInt((endDate - startData) / 1000);
    //天数
    let days = Math.floor(totalSeconds / (60 * 60 * 24));
    //取余数
    let modulo = totalSeconds % (60 * 60 * 24);
    //小时数
    let hours = Math.floor(modulo / (60 * 60));
    modulo = modulo % (60 * 60);
    //分钟
    let minutes = Math.floor(modulo / 60);
    //秒
    let seconds = modulo % 60;
    //console.log("date.util-getDiffTimeStr:"+"剩余抢购:" + days + "天" + hours + "：" + minutes + "：" + seconds);
	return days;
};
```



### 选择器设置开始时间对结束时间的影响

```javascript
setStartDate(e){
    this.formData.startTime = e.detail.value;
    if(this.formData.startTime > this.formData.endTime){
        this.formData.endTime = str;
    }
}
```

